#!/usr/bin/env bash
# 7-highlander script:
# Prints "To infinity and beyond" every 2 seconds
# Prints "OK" exactly when receiving SIGTERM and keeps running
# When run with --stop, sends SIGTERM to running 7-highlander processes (using perl)

if [[ "$1" == "--stop" ]]; then
  pids=$(pgrep -f 7-highlander | grep -v $$)
  if [ -n "$pids" ]; then
    for pid in $pids; do
      perl -e "kill 15, $pid"
    done
  fi
  exit 0
fi

trap 'printf "OK\n"' SIGTERM

while true; do
  echo "To infinity and beyond"
  sleep 2
done
