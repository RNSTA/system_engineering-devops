#!/usr/bin/env bash
# 7-highlander script:
# Prints "To infinity and beyond" every 2 seconds
# Prints "I am invincible!!!" and "OK" when receiving SIGTERM and keeps running
# When run with --stop, sends SIGTERM to running 7-highlander processes (using perl)

if [ "$1" = "--stop" ]; then
    # Use perl to find and send SIGTERM to running 7-highlander process
    perl -e '
        use strict;
        use warnings;
        my $target = "7-highlander";
        open(my $ps, "-|", "ps -eo pid,comm") or die "Failed to run ps";
        while (<$ps>) {
            if ($_ =~ /^\s*(\d+)\s+$target$/) {
                kill "TERM", $1;
            }
        }
    '
    exit
fi

# Trap SIGTERM: respond with both messages, then keep running
`trap` 'echo "I am invincible!!!"' SIGTERM; echo "OK"' SIGTERM

# Infinite loop
while true; do
    echo "To infinity and beyond"
    sleep 2
done
