#!/usr/bin/env bash
# 7-highlander script:
# - Runs infinite loop printing "To infinity and beyond" every 2 seconds
# - On SIGTERM, prints "OK" (exactly) and continues running
# - When run with --stop, sends SIGTERM to running 7-highlander processes without kill/killall

if [[ "$1" == "--stop" ]]; then
  # Send SIGTERM to all running 7-highlander except this process
  pids=$(pgrep -f 7-highlander | grep -v $$)
  if [ -n "$pids" ]; then
    for pid in $pids; do
      perl -e "kill 15, $pid"
    done
  fi
  exit 0
fi

trap 'echo "OK"' SIGTERM

while true; do
  echo "To infinity and beyond"
  sleep 2
done
