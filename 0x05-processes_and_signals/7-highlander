#!/usr/bin/env bash
# 7-highlander script that:
# - Runs infinite loop printing "To infinity and beyond" every 2 seconds and traps SIGTERM
# - When run with --stop, sends SIGTERM to running 7-highlander processes without using kill or killall

if [[ "$1" == "--stop" ]]; then
  # Stopping mode: send SIGTERM to all running 7-highlander processes (except this one)
  pids=$(pgrep -f 7-highlander | grep -v $$)
  if [ -n "$pids" ]; then
    for pid in $pids; do
      perl -e "kill 15, $pid"
    done
  fi
  exit 0
fi

# Normal running mode: trap SIGTERM and print message but do not exit
trap 'echo "I am invincible!!!"' SIGTERM

while true; do
  echo "To infinity and beyond"
  sleep 2
done
